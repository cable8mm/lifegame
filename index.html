<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style type="text/css">
        *   { margin:0; padding:0; }
        html    { height:100%; width:320px; }
        body    { height:100%; }
        #screen { width:100%; height:100%; background:#000000; overflow:hidden; }
        #screen .cell   { position:absolute; width:1px; height:1px; color:#00ff00; }
    </style>
    <script type="text/javascript">
        var Lifegame = function(){
            var self = this;

            var width = 0;
            var height = 0;
            var generation = 1;
            var cells = [];

            var coverage = [];
            var coverageTerm = 0;

            var workers = [];
            var workerCount = 5;

            var setSize = function(obj) {
                self.setWidth(obj.clientWidth);
                self.setHeight(obj.clientHeight);
            };

            var startWorkers = function() {
                for ( var i = 0; i < workerCount; i++ ) {
                    workers[i] = new Worker("worker.js");
                    workers[i].onmessage = self.callbackWorker;
                }
            };

            var sendCommand = function(command) {
                var offset = 0;
                for ( var i = 0; i < workerCount; i++ ) {
                    if ( workers[i] != null ) {
                        workers[i].postMessage({command:command, process:i, offset:offset, limit:coverage[i]});
                        offset = coverage[i] + 1;
                    }
                }
            };

            var getCoverage = function(coverTerm) {
                var result = [];
                var coverage = 0;
                var resolution = getResolution();

                for (var i = 0; i < workerCount; i++) {
                    coverage = (i + 1) * coverTerm;
                    if ( coverage > resolution ) {
                        coverage = resolution;
                    }

                    result[i] = coverage;
                }

                return result;
            };

            var getResolution = function() {
                return self.getWidth() * self.getHeight();
            };

            var getCoverageTerm = function() {
                var resolution = getResolution();
                if ( resolution > 0 ) {
                    return Math.ceil(resolution / workerCount);
                } else {
                    return 0;
                }
            };

            this.intToPosition = function(param) {
                var result = [0, 0];
                if ( param > 0 ) {
                    var width = self.getWidth();
                    var interval = Math.floor(param / width);
                    result[1] = interval + 1;
                    result[0] = param - (interval * width);

                    if ( result[0] == 0 ) {
                        result[0] = width;
                        result[1] = result[1] - 1;
                    }
                }

                return result;
            };

            var closeWorkers = function() {
                for ( var i = 0; i < workerCount; i++ ) {
                    if ( workers[i] != null ) {
                        workers[i].terminate();
                        workers[i] = null;
                    }
                }
            };

            this.init = function(obj) {
                setSize(obj);
                startWorkers();
                coverageTerm = getCoverageTerm();
                coverage = getCoverage(coverageTerm);
                self.startGeneration();
            };

            this.callbackWorker = function(evt) {
                if ( evt.data.command == 'start' ) {
                    startGenerationCallback(evt.data);
                } else if ( evt.data.command == 'next' ) {
                    nextGenerationCallback(evt.data);
                }
            };

            this.startGeneration = function() {
                generation = 1;
                sendCommand("start");
            };

            var startGenerationCallback = function(packet) {

            };

            this.nextGeneration = function() {
                generation++;
                sendCommand("next");
            };

            var nextGenerationCallback = function(packet) {

            };

            this.getWidth = function() {
                return width;
            };

            this.setWidth = function(x) {
                width = x;
            };

            this.getHeight = function() {
                return height;
            };

            this.setHeight = function(y) {
                height = y;
            };

            this.getCells = function() {
                return cells;
            };

            this.addCells = function(cells) {

            };

            this.removeCells = function(cells) {

            }
        }
    </script>
</head>
<body>
    <div id="screen"></div>
    <script type="text/javascript">
        var gameService;
        window.onload = function(){
            gameService = new Lifegame();
            gameService.init(document.getElementById("screen"));
        }
    </script>
</body>
</html>